(()=>{function e(e){const t=(new TextEncoder).encode(e);return btoa(String.fromCharCode(...t))}function t(e){fetch("https://api.github.com/user/repos",{headers:{Authorization:`token ${e}`}}).then((e=>e.json())).then((e=>{const t=document.getElementById("repoList");let n="";chrome.storage.local.get(["ownerName"],(function(e){e.ownerName&&(n=e.ownerName)})),t.innerHTML="",e.length>0?e.forEach((e=>{const c=document.createElement("li");c.setAttribute("class","extension-li"),c.textContent=e.name,c.addEventListener("click",(function(){chrome.storage.local.set({selectedRepo:e.name},(function(){o(e.name,n),document.getElementById("postSection").style.display="flex"}))})),t.appendChild(c)})):t.innerHTML="Your repository not exist!! Please make your own.",document.getElementById("repoSection").style.display="flex"}))}function o(e,t){document.getElementById("repoSection").style.display="none",document.getElementById("ownerSection").style.display="flex",document.getElementById("selectedRepoSpan").innerHTML=`<a href="https://www.github.com/${t}/${e}" target="_blank" class="highlighted">${e}</a>`}document.addEventListener("DOMContentLoaded",(function(){chrome.storage.local.get(["githubToken","selectedRepo","ownerName","savedText"],(function(e){var n;e.githubToken?(document.getElementById("login").style.display="none",document.getElementById("logout").style.display="block",document.getElementById("ownerSection").style.display="flex",e.ownerName?(n=e.ownerName,document.getElementById("ownerNameSpan").innerHTML=`<a href="https://www.github.com/${n}" target="_blank" class="highlighted">${n}</a>`,document.getElementById("ownerNameP").style.display="flex",e.selectedRepo?(o(e.selectedRepo,e.ownerName),document.getElementById("postSection").style.display="flex",document.getElementById("selectedRepoP").style.display="flex",e.savedText&&(document.getElementById("postInput").value=e.savedText)):t(e.githubToken)):t(e.githubToken)):(document.getElementById("login").style.display="block",document.getElementById("logout").style.display="none")})),document.getElementById("login").addEventListener("click",(function(){const e=chrome.identity.getRedirectURL(),o=`https://github.com/login/oauth/authorize?client_id=Ov23liS8uJ1LJSioNTPc&redirect_uri=${encodeURIComponent(e)}&scope=repo`;chrome.identity.launchWebAuthFlow({url:o,interactive:!0},(function(o){if(chrome.runtime.lastError)return void console.error(chrome.runtime.lastError.message);const n=new URLSearchParams(new URL(o).search).get("code");fetch("https://github.com/login/oauth/access_token",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({client_id:"Ov23liS8uJ1LJSioNTPc",client_secret:"904fcc78be315af16780349f2f74d701aeb3fd34",code:n,redirect_uri:e})}).then((e=>e.json())).then((e=>{const o=e.access_token;chrome.storage.local.set({githubToken:o},(function(){document.getElementById("login").style.display="none",document.getElementById("logout").style.display="block",t(o)})),function(e){console.log(e),fetch("https://api.github.com/user",{headers:{Authorization:`token ${e}`}}).then((e=>e.json())).then((e=>{const t=e.login;chrome.storage.local.set({ownerName:t},(function(){console.log("Owner name stored:",t)}))}))}(o)}))}))})),document.getElementById("logout").addEventListener("click",(function(){chrome.storage.local.remove(["githubToken","selectedRepo","ownerName","savedText"],(function(){document.getElementById("login").style.display="block",document.getElementById("logout").style.display="none",document.getElementById("ownerSection").style.display="none",document.getElementById("repoSection").style.display="none",document.getElementById("postSection").style.display="none"}));let e=chrome.storage.local.get("githubToken");console.log(e)})),document.getElementById("save").addEventListener("click",(function(){const e=document.getElementById("postInput");chrome.storage.local.set({savedText:e.value}),alert("임시 저장되었습니다! submit 버튼으로 제출하면 자동으로 저장된 내용은 사라집니다.")})),document.getElementById("submitPost").addEventListener("click",(function(){chrome.storage.local.get("githubToken",(function(t){const o=t.githubToken;o?chrome.storage.local.get("selectedRepo",(function(t){const n=t.selectedRepo;if(!n)return void console.error("Selected repository not found");const c=document.getElementById("postInput").value,r=`${function(){const e=new Date;return`${e.getFullYear()}${(e.getMonth()+1).toString().padStart(2,"0")}${e.getDate().toString().padStart(2,"0")}`}()}.md`;chrome.storage.local.get("ownerName",(function(t){const s=t.ownerName;s?function(t,o,n,c,r){function s(t,o,n,c,r,i){fetch(`https://api.github.com/repos/${r}/${o}/contents/${i}/${n}`,{method:"GET",headers:{Authorization:`token ${t}`}}).then((a=>{if(404===a.status)return fetch(`https://api.github.com/repos/${r}/${o}/contents/${i}/${n}`,{method:"PUT",headers:{Authorization:`token ${t}`,"Content-Type":"application/json"},body:JSON.stringify({message:"Create new Markdown file",content:e(c)})});{const e=prompt(`파일 이름 '${n}'이 이미 존재합니다. 새 파일 이름을 입력하세요.`);if(e)return s(t,o,e+".md",c,r,i);throw new Error("파일 이름 입력이 취소되었습니다.")}})).then((e=>{if(201!==e.status)throw new Error("Failed to create file");alert(`파일 ${n}이(가) 생성되었습니다.`),document.getElementById("postInput").value=""})).catch((e=>{"Failed to create file"===e.message&&alert("Error: 커밋에 실패했습니다."),console.error("Error:",e)}))}const i=new Date;!function(t,o,n,c,r,i){fetch(`https://api.github.com/repos/${r}/${o}/contents/${i}`,{method:"GET",headers:{Authorization:`token ${t}`}}).then((a=>404===a.status?function(t,o,n,c,r,i){const a=i.split("/").pop(),l=i.split("/").slice(0,-1).join("/");e(""),fetch(`https://api.github.com/repos/${r}/${o}/contents/${l}`,{method:"GET",headers:{Authorization:`token ${t}`}}).then((e=>e.json())).then((e=>{const n=e.sha;return fetch(`https://api.github.com/repos/${r}/${o}/git/trees`,{method:"POST",headers:{Authorization:`token ${t}`,"Content-Type":"application/json"},body:JSON.stringify({base_tree:n,tree:[{path:a,mode:"040000",type:"tree",content:""}]})})})).then((e=>e.json())).then((e=>{const n=e.sha;return fetch(`https://api.github.com/repos/${r}/${o}/git/commits`,{method:"POST",headers:{Authorization:`token ${t}`,"Content-Type":"application/json"},body:JSON.stringify({message:"Create new folder",tree:n,parents:[]})})})).then((e=>e.json())).then((e=>{const n=e.sha;return fetch(`https://api.github.com/repos/${r}/${o}/git/refs/heads/main`,{method:"PATCH",headers:{Authorization:`token ${t}`,"Content-Type":"application/json"},body:JSON.stringify({sha:n})})})).then((()=>s(t,o,n,c,r,i))).catch((e=>{console.error("Error:",e)}))}(t,o,n,c,r,i):s(t,o,n,c,r,i))).catch((e=>{console.error("Error:",e)}))}(t,o,n,c,r,`${i.getFullYear()}/${String(i.getMonth()+1).padStart(2,"0")}`)}(o,n,r,c,s):console.error("No owner name found")}))})):console.error("GitHub token not found")})),chrome.storage.local.remove(["savedText"],(function(){}))}))}))})();